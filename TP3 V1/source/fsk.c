#include "fsk.h"
#include "hardware.h"

#define NFIR 35
#define NDELAYS 6 //5+1

//const real64_T B[34] = {
//  0.0001010395245011,  0.00117887892105, 0.002050177882161,0.0005712730519797,
//   -0.00385998542783,-0.007723459766351,-0.004927441981018,  0.00667963385154,
//    0.01936505662795,  0.01827009313005,-0.005301164628446,  -0.0397201726459,
//   -0.05298946183652, -0.01281561445299,  0.08535387880299,   0.2055360479448,
//      0.288231221002,    0.288231221002,   0.2055360479448,  0.08535387880299,
//   -0.01281561445299, -0.05298946183652,  -0.0397201726459,-0.005301164628446,
//    0.01827009313005,  0.01936505662795,  0.00667963385154,-0.004927441981018,
//  -0.007723459766351, -0.00385998542783,0.0005712730519797, 0.002050177882161,
//    0.00117887892105,0.0001010395245011
//};


static float h[NFIR] = {-0.000193843232,  0.000741663400,  0.00216954197,  0.00200690548,
						 -0.00156648218, -0.00686607503, -0.00806394630,  0,
						 0.0144164296,  0.0222006915,  0.00939122198, -0.0232666492,
						 -0.0520410072, -0.0411515043,  0.0305206168,  0.146638914,
						 0.255488475,  0.3,  0.255488475,  0.146638914,
						 0.0305206168, -0.0411515043, -0.0520410072, -0.0232666492,
						 0.00939122198,  0.0222006915,  0.0144164296,  0,
						 -0.00806394630, -0.00686607503, -0.00156648218,  0.00200690548,
						 0.00216954197,  0.000741663400, -0.000193843232};
static float x_[NFIR]; //FIR input
static float d[NDELAYS]; //delays.

void shiftarray(float arr[], uint8_t arrlen, uint8_t shifts); //for float

void FSKconfiguration(void) {
	uint8_t i;

	for (i = 0; i < NFIR; i++) {
		x_[i] = 0;
	}
	for (i = 0; i < NDELAYS; i++) {
		d[i] = 0;
	}
}

float FSKdemodulator(uint16_t data) {
	uint8_t i;
	float y;

	//bye bye offset. adjusts the signal between 1V and -1V
	 y = (float)(data)*2/1024 - 1; //if the resolution is 10 bits, divide it by 1024.

	//multipling delay.
	shiftarray(d, NDELAYS, 1);
	d[0] = y;
	y *= d[NDELAYS-1];

	shiftarray(x_, NFIR, 1);
	x_[0] = y;
	y = 0; //clear y.
	for(i = 0; i < NFIR; i++) {
		y += h[i]*x_[i];
	}

	return y;
}

void shiftarray(float arr[], uint8_t arrlen, uint8_t shifts) {
	uint8_t i, j;
	float temp1, temp2;

	for(i = 0; i < shifts; i++) {
		temp1 = arr[0];
		arr[0] = 0;
		for (j = 1; j < arrlen; j++) {
			temp2 = arr[j];
			arr[j] = temp1;
			temp1 = temp2;
		}
	}
}
